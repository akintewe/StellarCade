#!/bin/bash
# Pre-Push Hook for Stellarcade
# Ensures the project builds and tests pass before pushing to the remote.

set -e

echo "üöÄ Running pre-push verification (Build & Test)..."

# 1. Faster Rust Verification (Parallel & Smart)
if command -v cargo >/dev/null 2>&1; then
    # Change detection: only check contracts that have changed since branching/last push
    UPSTREAM_BRANCH=${UPSTREAM_BRANCH:-origin/main}
    CHANGED_FILES=$(git diff --name-only $UPSTREAM_BRANCH...HEAD)
    
    PIDS=()
    FAILED=0

    for dir in contracts/shared contracts/prize-pool contracts/random-generator contracts/coin-flip; do
        # Check if project root or this contract dir changed
        if echo "$CHANGED_FILES" | grep -qE "^Cargo\.(toml|lock)$|^$dir/"; then
            echo "   ü¶Ä Checking $dir (Parallel)..."
            (
                cd "$dir"
                cargo fmt --all -- --check > /dev/null 2>&1 || { echo "‚ùå $dir: Formatting failed"; exit 1; }
                cargo clippy --all-targets --all-features -- -D warnings > /dev/null 2>&1 || { echo "‚ùå $dir: Clippy found issues"; exit 1; }
                cargo test > /dev/null 2>&1 || { echo "‚ùå $dir: Tests failed"; exit 1; }
            ) &
            PIDS+=($!)
        else
            echo "   ‚è© Skipping $dir (No changes)"
        fi
    done

    # Wait for all parallel checks to finish
    for pid in "${PIDS[@]}"; do
        wait "$pid" || FAILED=$((FAILED + 1))
    done

    if [ $FAILED -ne 0 ]; then
        echo "‚ùå $FAILED Rust contract(s) failed verification! Push aborted."
        exit 1
    fi
else
    echo "‚ö†Ô∏è Cargo not found, skipping Rust verification."
fi

# 2. Build and Test Backend
echo "üì¶ Verifying backend..."
if command -v npm >/dev/null 2>&1; then
    cd backend
    npm test || { echo "‚ùå Backend tests failed! Push aborted."; exit 1; }
    cd ..
else
    echo "‚ö†Ô∏è NPM not found, skipping backend verification."
fi

echo "‚ú® All checks passed! Proceeding with push."
